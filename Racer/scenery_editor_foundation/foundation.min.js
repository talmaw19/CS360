var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(c,d,b){c!=Array.prototype&&c!=Object.prototype&&(c[d]=b.value)};$jscomp.getGlobal=function(c){return"undefined"!=typeof window&&window===c?c:"undefined"!=typeof global&&null!=global?global:c};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(c,d,b,e){if(d){b=$jscomp.global;c=c.split(".");for(e=0;e<c.length-1;e++){var a=c[e];a in b||(b[a]={});b=b[a]}c=c[c.length-1];e=b[c];d=d(e);d!=e&&null!=d&&$jscomp.defineProperty(b,c,{configurable:!0,writable:!0,value:d})}};$jscomp.polyfill("Array.prototype.fill",function(c){return c?c:function(c,b,e){var a=this.length||0;0>b&&(b=Math.max(0,a+b));if(null==e||e>a)e=a;e=Number(e);0>e&&(e=Math.max(0,a+e));for(b=Number(b||0);b<e;b++)this[b]=c;return this}},"es6-impl","es3");
$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(c){return $jscomp.SYMBOL_PREFIX+(c||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var c=$jscomp.global.Symbol.iterator;c||(c=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[c]&&$jscomp.defineProperty(Array.prototype,c,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(c){var d=0;return $jscomp.iteratorPrototype(function(){return d<c.length?{done:!1,value:c[d++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(c){$jscomp.initSymbolIterator();c={next:c};c[$jscomp.global.Symbol.iterator]=function(){return this};return c};$jscomp.iteratorFromArray=function(c,d){$jscomp.initSymbolIterator();c instanceof String&&(c+="");var b=0,e={next:function(){if(b<c.length){var a=b++;return{value:d(a,c[a]),done:!1}}e.next=function(){return{done:!0,value:void 0}};return e.next()}};e[Symbol.iterator]=function(){return e};return e};
$jscomp.polyfill("Array.prototype.keys",function(c){return c?c:function(){return $jscomp.iteratorFromArray(this,function(c){return c})}},"es6-impl","es3");OverDrive.MetLib=function(c){c.fEqual=function(c,b,e){return Math.abs(c-b)<(void 0===e?1E-8:e)};return c}(OverDrive.MetLib||{});OverDrive.Region=function(c,d,b){c.Create=function(){return{points:[],collisionModel:{vertices:null,isConvex:!1}}};c.BuildCollisionModel=function(b){b.collisionModel.vertices=Matter.Vertices.create(b.points,Matter.Body.create({}));Matter.Vertices.clockwiseSort(b.collisionModel.vertices);b.collisionModel.isConvex=Matter.Vertices.isConvex(b.collisionModel.vertices)};c.Render=function(c,a,f){f=void 0===f?"#00F":f;b.beginPath();b.moveTo(c.points[0].x*d.width,c.points[0].y*d.height);for(var g=1;g<c.points.length;++g)b.lineTo(c.points[g].x*
d.width,c.points[g].y*d.height);b.closePath();b.globalAlpha=.2;b.fillStyle=f;b.fill();b.globalAlpha=1;c.collisionModel.isConvex?(b.strokeStyle="#FFF",b.fillStyle="#FFF"):(b.strokeStyle="#F00",b.fillStyle="#F00");b.beginPath();b.moveTo(c.points[0].x*d.width,c.points[0].y*d.height);for(g=1;g<c.points.length;++g)b.lineTo(c.points[g].x*d.width,c.points[g].y*d.height);1==a&&b.closePath();b.lineWidth=1;b.stroke();for(g=0;g<c.points.length;++g)b.beginPath(),b.arc(c.points[g].x*d.width,c.points[g].y*d.height,
5,0,2*Math.PI),b.fill()};return c}(OverDrive.Region||{},OverDrive.canvas,OverDrive.context);OverDrive.Proximity=function(c,d,b){function e(){var a=this;this.closeLoopPoint=null;this.newRegionPoints=[];this.points=[];this.numPoints=function(){return a.newRegionPoints.length+a.points.length+(null!=a.closeLoopPoint)?1:0}}c.CreateProximityList=function(){return new e};c.SqrCanvasDist=function(a,f){var g=a.x*d.width-f.x*d.width,c=a.y*d.height-f.y*d.height;return g*g+c*c};c.PointInProximity=function(a,f,g){return c.SqrCanvasDist(a,f)<g};c.GetPointsInProximity=function(a,f,g,b){var d=new e;if(g){c.PointInProximity(a,
g.points[0],b)&&(d.closeLoopPoint=g.points[0]);for(var h=1;h<g.points.length;++h)c.PointInProximity(a,g.points[h],b)&&d.newRegionPoints.push(g.points[h])}for(g=0;g<f.length;++g)for(h=0;h<f[g].points.length;++h)c.PointInProximity(a,f[g].points[h],b)&&d.points.push({coord:f[g].points[h],regionIndex:g,pointIndex:h});return d};c.GetDisjointPointSet=function(a,f){for(var g=[],c=0;c<f.length;++c)for(var b=0;b<f[c].points.length;++b){for(var d=!1,e=0;e<a.points.length&&!d;++e)d=a.points[e].regionIndex==
c&&a.points[e].pointIndex==b;d||g.push({coord:f[c].points[b],regionIndex:c,pointIndex:b})}return g};c.GetStaticPointsInProximity=function(a,f,g){for(var b=[],d=0;d<f.length;++d)c.PointInProximity(a,f[d].coord,g)&&b.push(f[d]);return b};c.PointInList=function(a,f){for(var b=!1,c=0;c<f.length&&!b;++c)b=a.regionIndex==f[c].regionIndex&&a.pointIndex==f[c].pointIndex;return b};return c}(OverDrive.Proximity||{},OverDrive.canvas,OverDrive.context);OverDrive.Background=function(c,d,b){function e(){var a=this;this.loaded=!1;this.image=null;this.imageURL="";this.load=function(c,b){a.image=new Image;a.image.onload=function(){a.loaded=!0;a.imageURL=c;void 0!==b&&b(a)};a.image.src=c};this.render=function(){b.clearRect(0,0,d.width,d.height);if(0==a.loaded){b.fillStyle="#000";b.font="18px Arial";var c=b.measureText("--- No track image loaded ---");b.fillText("--- No track image loaded ---",d.width/2-c.width/2,d.height/2)}else b.drawImage(a.image,0,
0,d.width,d.height)}}c.Create=function(){return new e};c.Load=function(a,c,b){a.load(c,b)};c.Render=function(a){a.render()};return c}(OverDrive.Background||{},OverDrive.canvas,OverDrive.context);OverDrive.EditorStage=function(c,d,b){c.Create=function(){var b=new c.Editor;b.elementActivationMap=[];b.elementActivationMap["#li_navNew"]=function(a){$("#li_navNew").attr("class",null);return!0};b.elementActivationMap["#li_navOpen"]=function(a){$("#li_navOpen").attr("class",null);return!0};b.elementActivationMap["#li_navSave"]=function(a){a=null!=a.model&&1==a.model.edited;$("#li_navSave").attr("class",a?null:"disabled");return a};b.elementActivationMap["#li_navExport"]=function(a){a=null!=a.model;
$("#li_navExport").attr("class",a?null:"disabled");return a};b.elementActivationMap["#trackNumberLabel"]=function(a){var b=(a=null!=a.model)?"#000":"#888";$("#trackNumberLabel").css("color",b);return a};b.elementActivationMap["#trackNumberField"]=function(a){a=null!=a.model;$("#trackNumberField").prop("disabled",!a);return a};b.elementActivationMap["#trackImageImportButton"]=function(a){a=null!=a.model;$("#trackImageImportButton").prop("disabled",!a);return a};b.elementActivationMap["#trackFileNameLabel"]=
function(a){var b=(a=null!=a.model)?"#000":"#888";$("#trackFileNameLabel").css("color",b);return a};return b};return c}(OverDrive.EditorStage||{},OverDrive.canvas,OverDrive.context);
OverDrive.EditorStage=function(c,d,b){var e=function(a){return a.model&&a.model.trackImage&&a.model.trackImage.loaded};c.Editor=function(){var a=this;this.transitionLinks={};this.setTransition=function(a,b){this.transitionLinks[a]=b};this.newRegion=this.model=null;this.proximityThreshold=20;this.pStatic=this.proximityList=null;this.moveVertices=!1;this.mouseInCanvas=!0;this.currentMousePos={x:0,y:0};this.bootstrapEditor=!0;this.leaveState={id:null,params:null};this.render=function(){OverDrive.Background.Render(this.model.trackImage);
for(var a=0;a<this.model.regions.length;++a)OverDrive.Region.Render(this.model.regions[a],!0,"#00F");if(null!=this.newRegion){b.beginPath();b.moveTo(this.newRegion.points[0].x*d.width,this.newRegion.points[0].y*d.height);for(var c=1;c<this.newRegion.points.length;++c)b.lineTo(this.newRegion.points[c].x*d.width,this.newRegion.points[c].y*d.height);1==this.mouseInCanvas?(0<this.newRegion.points.length&&b.lineTo(this.currentMousePos.x*d.width,this.currentMousePos.y*d.height),b.lineWidth=1,b.strokeStyle=
"#0F0"):(b.lineWidth=1,b.strokeStyle="#FFF",b.stroke(),b.beginPath(),b.moveTo(0,0),b.lineTo(d.width-1,0),b.lineTo(d.width-1,d.height-1),b.lineTo(0,d.height-1),b.lineTo(0,0),b.lineWidth=4,b.strokeStyle="#F00");b.stroke();b.fillStyle="#FFF";for(c=0;c<this.newRegion.points.length;++c)b.beginPath(),b.arc(this.newRegion.points[c].x*d.width,this.newRegion.points[c].y*d.height,3,0,2*Math.PI),b.fill();if(0<this.proximityList.numPoints())if(null!=this.proximityList.closeLoopPoint)b.fillStyle=2>=this.newRegion.points.length?
"#F00":"#0F0",b.beginPath(),b.arc(this.proximityList.closeLoopPoint.x*d.width,this.proximityList.closeLoopPoint.y*d.height,5,0,2*Math.PI),b.fill();else{b.fillStyle="#F00";for(a=0;a<this.proximityList.newRegionPoints.length;++a)b.beginPath(),b.arc(this.proximityList.newRegionPoints[a].x*d.width,this.proximityList.newRegionPoints[a].y*d.height,5,0,2*Math.PI),b.fill();b.fillStyle="#0F0";for(a=0;a<this.proximityList.points.length;++a)b.beginPath(),b.arc(this.proximityList.points[a].coord.x*d.width,this.proximityList.points[a].coord.y*
d.height,5,0,2*Math.PI),b.fill()}}else{if(null!=this.proximityList)for(b.fillStyle="#0F0",a=0;a<this.proximityList.points.length;++a)b.beginPath(),b.arc(this.proximityList.points[a].coord.x*d.width,this.proximityList.points[a].coord.y*d.height,5,0,2*Math.PI),b.fill();if(this.moveVertices)for(var e=this.proximityList.points,a=0;a<e.length;++a){var l=OverDrive.Proximity.GetStaticPointsInProximity(e[a].coord,this.pStatic,this.proximityThreshold);if(0<l.length)for(c=0;c<l.length;++c)l[c].regionIndex!=
e[a].regionIndex&&(b.strokeStyle="#0F0",b.beginPath(),b.arc(l[c].coord.x*d.width,l[c].coord.y*d.height,10,0,2*Math.PI),b.stroke())}}};this.newScenery=function(c){c=!0;a.model&&1==a.model.edited&&(c=window.confirm("You're creating a new scenery model.  Any changes made to the current scenery will be lost.  Do you want to proceed?"));c&&(a.model=new OverDrive.Editor.EditorModel,$("#trackNumberField").val(a.model.trackNumber),$("#trackFileNameLabel").html("(No track image selected)"),a.enableElements())};
this.preloadSceneryModel=function(c){var b=!0;a.model&&1==a.model.edited&&(b=window.confirm("You're loading a new scenery model.  Any changes made to the current scenery will be lost.  Do you want to proceed?"));b||c.preventDefault()};this.loadSceneryModel=function(c){c=$("#loadSceneryModelInput").val().split("\\");var b=new XMLHttpRequest;b.open("GET","Editor\\Models\\"+c[c.length-1],!0);b.responseType="text";b.onload=function(){a.loadSceneryModelCompleted(b.responseText)};b.send();return!1};this.loadSceneryModelCompleted=
function(c){c=JSON.parse(c);a.model=new OverDrive.Editor.EditorModel;a.model.trackNumber=c.trackNumber;$("#trackNumberField").val(a.model.trackNumber);var b=c.trackImage.imageURL,d=b.split("\\");OverDrive.Background.Load(a.model.trackImage,b,function(a){$("#trackFileNameLabel").html(d[d.length-1])});a.model.regions=[];for(b=0;b<c.regions.length;++b){var f=OverDrive.Region.Create();f.points=c.regions[b].points;OverDrive.Region.BuildCollisionModel(f);a.model.regions.push(f)}a.enableElements()};this.saveScenery=
function(c){var b=prompt("Enter name of scenery file to save");if(null!=b){for(var b=b+".od_scenery.json",d={trackNumber:a.model.trackNumber,trackImage:a.model.trackImage,regions:[]},f=0;f<a.model.regions.length;++f)d.regions.push({points:a.model.regions[f].points});d=JSON.stringify(d);d=new Blob([d],{type:"text/plain;charset=utf-8"});d=URL.createObjectURL(d,{oneTimeOnly:!0});c=c.currentTarget;c.download=b;c.href=d;a.model.edited=!1;a.enableElements();return!0}};this.exportScenery=function(c){var b=
prompt("Export track to script file");if(null!=b){for(var b=b+".od_scenery.js",d={trackNumber:a.model.trackNumber,trackImage:a.model.trackImage,regions:[]},f=0;f<a.model.regions.length;++f)d.regions.push({points:a.model.regions[f].points});d="OverDrive.Game.scenery["+(d.trackNumber-1)+"] = "+JSON.stringify(d)+";";d=new Blob([d],{type:"text/plain;charset=utf-8"});d=URL.createObjectURL(d,{oneTimeOnly:!0});c=c.currentTarget;c.download=b;c.href=d;return!0}};this.preloadTrackImage=function(c){var b=!0;
0<a.model.regions.length&&(b=window.confirm("You're loading a new track picture.  The existing scenery model may not match.  Do you want to proceed?"));b||c.preventDefault()};this.loadTrackImage=function(c){var b=$("#loadTrackImageInput").val().split("\\");OverDrive.Background.Load(a.model.trackImage,"Assets\\Images\\"+b[b.length-1],function(c){$("#trackFileNameLabel").html(b[b.length-1]);a.model.edited=!0;a.enableElements()})};this.setTrackNumber=function(b){a.model.trackNumber=b.currentTarget.value;
a.model.edited=!0;a.enableElements()};this.getNormalisedMouseCoords=function(a){var b=d.getBoundingClientRect();return{x:(a.clientX-b.left)/(b.right-b.left),y:(a.clientY-b.top)/(b.bottom-b.top)}};this.mouseDown=function(b){a.currentMousePos=a.getNormalisedMouseCoords(b);e(a)&&(a.proximityList=OverDrive.Proximity.GetPointsInProximity(a.currentMousePos,a.model.regions,a.newRegion,a.proximityThreshold),null==a.newRegion?b.ctrlKey?0<a.proximityList.points.length&&(a.pStatic=OverDrive.Proximity.GetDisjointPointSet(a.proximityList,
a.model.regions),a.moveVertices=!0):(a.newRegion=OverDrive.Region.Create(),0<a.proximityList.points.length?a.newRegion.points.push(a.proximityList.points[0].coord):a.newRegion.points.push(a.currentMousePos)):0<a.proximityList.numPoints()?null!=a.proximityList.closeLoopPoint?(OverDrive.Region.BuildCollisionModel(a.newRegion),a.model.regions.push(a.newRegion),a.newRegion=null,a.model.edited=!0,a.enableElements()):0<a.proximityList.points.length&&a.newRegion.points.push(a.proximityList.points[0].coord):
a.newRegion.points.push(a.currentMousePos))};this.mouseUp=function(b){if(e(a)&&a.moveVertices){b=a.proximityList.points;for(var c=0;c<b.length;++c){var d=OverDrive.Proximity.GetStaticPointsInProximity(b[c].coord,a.pStatic,a.proximityThreshold);if(0<d.length){for(var f=null,m=0,k=0;k<d.length;++k)if(d[k].regionIndex!=b[c].regionIndex)if(null==f)f=d[k],m=OverDrive.Proximity.SqrCanvasDist(d[k].coord,b[c].coord);else{var n=OverDrive.Proximity.SqrCanvasDist(d[k].coord,b[c].coord);n<m&&(f=d[k],m=n)}null!=
f&&(b[c].coord.x=f.coord.x,b[c].coord.y=f.coord.y)}}for(c=0;c<a.model.regions.length;++c)OverDrive.Region.BuildCollisionModel(a.model.regions[c]);a.pStatic=null;a.moveVertices=!1;a.model.edited=!0;a.enableElements()}};this.mouseMove=function(b){a.currentMousePos=a.getNormalisedMouseCoords(b);if(e(a))if(a.moveVertices)for(b=0;b<a.proximityList.points.length;++b)a.proximityList.points[b].coord.x=a.currentMousePos.x,a.proximityList.points[b].coord.y=a.currentMousePos.y;else a.proximityList=OverDrive.Proximity.GetPointsInProximity(a.currentMousePos,
a.model.regions,a.newRegion,a.proximityThreshold)};this.mouseEnter=function(b){a.mouseInCanvas=!0;a.currentMousePos=a.getNormalisedMouseCoords(b);e(a)&&(a.proximityList=OverDrive.Proximity.GetPointsInProximity(a.currentMousePos,a.model.regions,a.newRegion,a.proximityThreshold))};this.mouseLeave=function(b){a.mouseInCanvas=!1};this.keyDown=function(b){switch(b.keyCode){case 46:e(a)&&!a.moveVertices&&(a.newRegion?a.newRegion=null:0<a.model.regions.length&&(a.model.regions.pop(),a.model.edited=!0,a.enableElements()),
a.proximityList=OverDrive.Proximity.GetPointsInProximity(a.currentMousePos,a.model.regions,a.newRegion,a.proximityThreshold))}}};return c}(OverDrive.EditorStage||{},OverDrive.canvas,OverDrive.context);OverDrive.EditorStage=function(c,d,b){c.Editor.prototype.enableElements=function(){var b=this.elementActivationMap;Object.keys(b).forEach(function(a){b[a](this)},this)};return c}(OverDrive.EditorStage||{},OverDrive.canvas,OverDrive.context);OverDrive.EditorStage=function(c,d,b){c.Editor.prototype.init=function(){this.bootstrapEditor&&($("#navNew").click(this.newScenery),$("#navSave").click(this.saveScenery),$("#navExport").click(this.exportScenery),$("#loadSceneryModelInput").click(this.preloadSceneryModel),$("#loadSceneryModelInput").change(this.loadSceneryModel),$("#loadTrackImageInput").click(this.preloadTrackImage),$("#loadTrackImageInput").change(this.loadTrackImage),$("#trackNumberField").change(this.setTrackNumber),this.bootstrapEditor=
!1);$("#canvas").on("mousedown",this.mouseDown);$("#canvas").on("mousemove",this.mouseMove);$("#canvas").on("mouseenter",this.mouseEnter);$("#canvas").on("mouseleave",this.mouseLeave);$("#canvas").on("mouseup",this.mouseUp);$(document).on("keydown",this.keyDown);this.enableElements();window.requestAnimationFrame(this.mainLoop.bind(this))};c.Editor.prototype.mainLoop=function(){this.model&&this.render();window.requestAnimationFrame(this.mainLoop.bind(this))};return c}(OverDrive.EditorStage||{},OverDrive.canvas,
OverDrive.context);OverDrive.Editor=function(c,d,b){c.EditorModel=function(){this.edited=!1;this.trackNumber=1;this.trackImage=OverDrive.Background.Create();this.regions=[]};return c}(OverDrive.Editor||{},OverDrive.canvas,OverDrive.context);
